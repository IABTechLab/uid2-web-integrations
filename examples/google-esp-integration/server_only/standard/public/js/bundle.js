(()=>{"use strict";var e={524:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.setupGoogleTag=void 0,t.setupGoogleTag=function(){window.googletag||(window.googletag={}),window.googletag.encryptedSignalProviders||(window.googletag.encryptedSignalProviders=[]),window.googletag.encryptedSignalProviders.push({id:"uidapi.com",collectorFunction:()=>window.__uid2&&"getAdvertisingTokenAsync"in window.__uid2?window.__uid2.getAdvertisingTokenAsync():Promise.reject(new Error("UID2 SDK not present"))})}},560:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isValidIdentity=void 0,t.isValidIdentity=function(e){return"object"==typeof e&&null!==e&&"advertising_token"in e&&"identity_expires"in e&&"refresh_from"in e&&"refresh_token"in e&&"refresh_expires"in e}},18:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.notifyInitCallback=t.IdentityStatus=void 0,(i=t.IdentityStatus||(t.IdentityStatus={}))[i.ESTABLISHED=0]="ESTABLISHED",i[i.REFRESHED=1]="REFRESHED",i[i.EXPIRED=100]="EXPIRED",i[i.NO_IDENTITY=-1]="NO_IDENTITY",i[i.INVALID=-2]="INVALID",i[i.REFRESH_EXPIRED=-3]="REFRESH_EXPIRED",i[i.OPTOUT=-4]="OPTOUT",t.notifyInitCallback=function(e,t,i,n){if(e.callback){const s={advertisingToken:n,advertising_token:n,status:t,statusText:i};try{e.callback(s)}catch(e){console.warn("UID2 init callback threw an exception",e)}}}},702:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isUID2OptionsOrThrow=void 0,t.isUID2OptionsOrThrow=function(e){if("object"!=typeof e||null===e)throw new TypeError("opts must be an object");const t=e;if(void 0!==t.callback&&"function"!=typeof t.callback)throw new TypeError("opts.callback, if provided, must be a function");if(void 0!==t.refreshRetryPeriod){if("number"!=typeof t.refreshRetryPeriod)throw new TypeError("opts.refreshRetryPeriod must be a number");if(t.refreshRetryPeriod<1e3)throw new RangeError("opts.refreshRetryPeriod must be >= 1000")}return!0}},203:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sdkWindow=t.UID2=void 0;const n=i(524),s=i(884),r=i(41),o=i(655),a=i(18),d=i(702),l=i(75);function c(e,t=Date.now()){return e<=t}class h{constructor(e){this.callbacks=[],this._opts={},this._initComplete=!1,this._refreshTimerId=null,e&&(this.callbacks=e),this._tokenPromiseHandler=new l.UID2PromiseHandler(this),this._callbackManager=new r.Uid2CallbackManager(this,(()=>this.getIdentity())),this._callbackManager.runCallbacks(r.EventType.SdkLoaded,{})}static get VERSION(){return"3.0.0"}static get COOKIE_NAME(){return"__uid_2"}static get DEFAULT_REFRESH_RETRY_PERIOD_MS(){return 5e3}init(e){this.initInternal(e)}getAdvertisingToken(){var e,t;return null!==(t=null===(e=this.getIdentity())||void 0===e?void 0:e.advertising_token)&&void 0!==t?t:void 0}getIdentity(){return this._identity&&!this.temporarilyUnavailable()?this._identity:null}getAdvertisingTokenAsync(){const e=this.getAdvertisingToken();return this._tokenPromiseHandler.createMaybeDeferredPromise(null!=e?e:null)}isLoginRequired(){var e;if(this._initComplete)return!(this.isLoggedIn()||(null===(e=this._apiClient)||void 0===e?void 0:e.hasActiveRequests()))}disconnect(){this.abort("UID2 SDK disconnected."),this._cookieManager?this._cookieManager.removeCookie():new o.UID2CookieManager({}).removeCookie(),this._identity=void 0,this._callbackManager.runCallbacks(h.EventType.IdentityUpdated,{identity:null})}abort(e){this._initComplete=!0,this._tokenPromiseHandler.rejectAllPromises(null!=e?e:new Error("UID2 SDK aborted.")),this._refreshTimerId&&(clearTimeout(this._refreshTimerId),this._refreshTimerId=null),this._apiClient&&this._apiClient.abortActiveRequests()}setIdentity(e){const t=this.validateAndSetIdentity(e);t&&this.triggerRefreshOrSetTimer(t)}initInternal(e){var t;if(this._initComplete)throw new TypeError("Calling init() more than once is not allowed");if(!(0,d.isUID2OptionsOrThrow)(e))throw new TypeError("Options provided to UID2 init couldn't be validated.");this._opts=e,this._cookieManager=new o.UID2CookieManager(Object.assign({},e)),this._apiClient=new s.Uid2ApiClient(e);const i=this._opts.identity?this._opts.identity:this._cookieManager.loadIdentityFromCookie(),n=this.validateAndSetIdentity(i);n&&this.triggerRefreshOrSetTimer(n),this._initComplete=!0,null===(t=this._callbackManager)||void 0===t||t.runCallbacks(r.EventType.InitCompleted,{})}isLoggedIn(){return this._identity&&!c(this._identity.refresh_expires)}temporarilyUnavailable(){var e;return!(this._identity||!(null===(e=this._apiClient)||void 0===e?void 0:e.hasActiveRequests()))||!(!this._identity||!c(this._identity.identity_expires)||c(this._identity.refresh_expires))}getIdentityStatus(e){return e?e.advertising_token?e.refresh_token?c(e.refresh_expires,Date.now())?{valid:!1,errorMessage:"Identity expired, refresh expired",status:a.IdentityStatus.REFRESH_EXPIRED,identity:null}:c(e.identity_expires,Date.now())?{valid:!0,errorMessage:"Identity expired, refresh still valid",status:a.IdentityStatus.EXPIRED,identity:e}:void 0===this._identity?{valid:!0,identity:e,status:a.IdentityStatus.ESTABLISHED,errorMessage:"Identity established"}:{valid:!0,identity:e,status:a.IdentityStatus.REFRESHED,errorMessage:"Identity refreshed"}:{valid:!1,errorMessage:"refresh_token is not available or is not valid",status:a.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"advertising_token is not available or is not valid",status:a.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"Identity not available",status:h.IdentityStatus.NO_IDENTITY,identity:null}}validateAndSetIdentity(e,t,i){var n,s;if(!this._cookieManager)throw new Error("Cannot set identity before calling init.");const r=this.getIdentityStatus(e);return r.identity&&(null===(n=r.identity)||void 0===n?void 0:n.advertising_token)===(null===(s=this._identity)||void 0===s?void 0:s.advertising_token)||(this._identity=r.identity,r.identity?this._cookieManager.setCookie(r.identity):(this.abort(),this._cookieManager.removeCookie()),(0,a.notifyInitCallback)(this._opts,null!=t?t:r.status,null!=i?i:r.errorMessage,this.getAdvertisingToken())),r.identity}triggerRefreshOrSetTimer(e){c(e.refresh_from,Date.now())?this.refreshToken(e):this.setRefreshTimer()}setRefreshTimer(){var e,t;const i=null!==(t=null===(e=this._opts)||void 0===e?void 0:e.refreshRetryPeriod)&&void 0!==t?t:h.DEFAULT_REFRESH_RETRY_PERIOD_MS;this._refreshTimerId=setTimeout((()=>{var e,t;if(this.isLoginRequired())return;const i=this.validateAndSetIdentity(null!==(t=null===(e=this._cookieManager)||void 0===e?void 0:e.loadIdentityFromCookie())&&void 0!==t?t:null);i&&this.triggerRefreshOrSetTimer(i)}),i)}refreshToken(e){const t=this._apiClient;if(!t)throw new Error("Cannot refresh the token before calling init.");t.callRefreshApi(e).then((e=>{switch(e.status){case"success":this.validateAndSetIdentity(e.identity,a.IdentityStatus.REFRESHED,"Identity refreshed"),this.setRefreshTimer();break;case"optout":this.validateAndSetIdentity(null,a.IdentityStatus.OPTOUT,"User opted out");break;case"expired_token":this.validateAndSetIdentity(null,a.IdentityStatus.REFRESH_EXPIRED,"Refresh token expired")}}),(t=>{console.warn("Encountered an error refreshing the UID2 token",t),this.validateAndSetIdentity(e),c(e.refresh_expires,Date.now())||this.setRefreshTimer()})).then((()=>{this._callbackManager.runCallbacks(r.EventType.IdentityUpdated,{})}),(e=>console.warn("UID2 callbacks on identity event failed.",e)))}}t.UID2=h,h.IdentityStatus=a.IdentityStatus,h.EventType=r.EventType,h.setupGoogleTag=n.setupGoogleTag,function(){var e;const t=(null===(e=null===window||void 0===window?void 0:window.__uid2)||void 0===e?void 0:e.callbacks)||[];window.__uid2=new h(t)}(),t.sdkWindow=globalThis.window},884:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Uid2ApiClient=void 0;const n=i(203),s=i(560);t.Uid2ApiClient=class{constructor(e){var t;this._requestsInFlight=[],this._baseUrl=null!==(t=e.baseUrl)&&void 0!==t?t:"https://prod.uidapi.com",this._clientVersion="uid2-sdk-"+n.UID2.VERSION}createArrayBuffer(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}hasActiveRequests(){return this._requestsInFlight.length>0}ResponseToRefreshResult(e){return function(e){return!!function(e){return"object"==typeof e&&null!==e&&"status"in e}(e)&&("optout"===e.status||"expired_token"===e.status||"success"===e.status&&"body"in e&&(0,s.isValidIdentity)(e.body))}(e)?"success"===e.status?{status:e.status,identity:e.body}:e:"Response didn't contain a valid status"}abortActiveRequests(){this._requestsInFlight.forEach((e=>{e.abort()})),this._requestsInFlight=[]}callRefreshApi(e){const t=this._baseUrl+"/v2/token/refresh",i=new XMLHttpRequest;let n,s;this._requestsInFlight.push(i),i.overrideMimeType("text/plain"),i.open("POST",t,!0),i.setRequestHeader("X-UID2-Client-Version",this._clientVersion);const r=new Promise(((e,t)=>{n=e,s=t}));return i.onreadystatechange=()=>{if(i.readyState===i.DONE){this._requestsInFlight=this._requestsInFlight.filter((e=>e!==i));try{if(e.refresh_response_key&&200===i.status){const t=this.createArrayBuffer(atob(i.responseText));window.crypto.subtle.importKey("raw",this.createArrayBuffer(atob(e.refresh_response_key)),{name:"AES-GCM"},!1,["decrypt"]).then((e=>{window.crypto.subtle.decrypt({name:"AES-GCM",iv:t.slice(0,12),tagLength:128},e,t.slice(12)).then((e=>{const t=String.fromCharCode(...new Uint8Array(e)),i=JSON.parse(t),r=this.ResponseToRefreshResult(i);"string"==typeof r?s(r):n(r)}),(e=>console.warn("Call to UID2 API failed",e)))}),(e=>console.warn("Call to UID2 API failed",e)))}else{const e=JSON.parse(i.responseText),t=this.ResponseToRefreshResult(e);"string"==typeof t?s(t):n(t)}}catch(e){s(e)}}},i.send(e.refresh_token),r}}},41:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Uid2CallbackManager=t.EventType=void 0,function(e){e.InitCompleted="InitCompleted",e.IdentityUpdated="IdentityUpdated",e.SdkLoaded="SdkLoaded"}(i=t.EventType||(t.EventType={}));class n{constructor(e,t){this._sentInit=!1,this._getIdentity=t,this._uid2=e,this._uid2.callbacks.push=this.callbackPushInterceptor.bind(this)}callbackPushInterceptor(...e){var t;const s=Array.prototype.push.apply(this._uid2.callbacks,e);for(const s of e)n._sentSdkLoaded&&this.safeRunCallback(s,i.SdkLoaded,{}),this._sentInit&&this.safeRunCallback(s,i.InitCompleted,{identity:null!==(t=this._getIdentity())&&void 0!==t?t:null});return s}runCallbacks(e,t){var s;if(e===i.InitCompleted&&(this._sentInit=!0),e===i.SdkLoaded&&(n._sentSdkLoaded=!0),!this._sentInit&&e!==i.SdkLoaded)return;const r=Object.assign(Object.assign({},t),{identity:null!==(s=this._getIdentity())&&void 0!==s?s:null});for(const t of this._uid2.callbacks)this.safeRunCallback(t,e,r)}safeRunCallback(e,t,i){if("function"==typeof e)try{e(t,i)}catch(e){console.warn("UID2 callback threw an exception",e)}else console.warn("A UID2 SDK callback was supplied which isn't a function.")}}t.Uid2CallbackManager=n,n._sentSdkLoaded=!1},655:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2CookieManager=t.isLegacyCookie=void 0;const n=i(203),s=i(560);function r(e){if("object"!=typeof e||!e)return!1;const t=e;return!!("advertising_token"in t&&"refresh_token"in t&&t.advertising_token&&t.refresh_token)}t.isLegacyCookie=r,t.UID2CookieManager=class{constructor(e){this._cookieName=n.UID2.COOKIE_NAME,this._opts=e}setCookie(e){var t;const i=JSON.stringify(e),n=new Date(e.refresh_expires),s=null!==(t=this._opts.cookiePath)&&void 0!==t?t:"/";let r=this._cookieName+"="+encodeURIComponent(i)+" ;path="+s+";expires="+n.toUTCString();void 0!==this._opts.cookieDomain&&(r+=";domain="+this._opts.cookieDomain),document.cookie=r}removeCookie(){document.cookie=this._cookieName+"=;expires=Tue, 1 Jan 1980 23:59:59 GMT"}getCookie(){const e=document.cookie;if(e){const t=e.split("; ").find((e=>e.startsWith(this._cookieName+"=")));if(t)return decodeURIComponent(t.split("=")[1])}}loadIdentityFromCookie(){const e=this.getCookie();if(e){const n=JSON.parse(e);if((0,s.isValidIdentity)(n))return n;if(r(n))return t=n,i=Date.now(),Object.assign({refresh_from:i,refresh_expires:i+6048e5,identity_expires:i+144e5},t)}var t,i;return null}}},75:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2PromiseHandler=void 0;const n=i(41);t.UID2PromiseHandler=class{constructor(e){this._promises=[],this._seenInitOrRejectAll=!1,e.callbacks.push(this._handleEvent.bind(this))}_handleEvent(e,t){e===n.EventType.InitCompleted&&(this._seenInitOrRejectAll=!0,this._promises.forEach((e=>{"identity"in t&&t.identity?e.resolve(t.identity.advertising_token):e.reject(new Error("No identity available."))})),this._promises=[])}rejectAllPromises(e){this._seenInitOrRejectAll=!0,this._promises.forEach((t=>{t.reject(e)})),this._promises=[]}createMaybeDeferredPromise(e){return this._seenInitOrRejectAll?e?Promise.resolve(e):Promise.reject(new Error("Identity not available")):new Promise(((e,t)=>{this._promises.push({resolve:e,reject:t})}))}}}},t={};!function i(n){var s=t[n];if(void 0!==s)return s.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}(203)})();